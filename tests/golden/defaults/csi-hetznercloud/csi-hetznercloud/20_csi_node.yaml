apiVersion: apps/v1
kind: DaemonSet
metadata:
  annotations: {}
  labels:
    name: hcloud-csi-node
  name: hcloud-csi-node
spec:
  selector:
    matchLabels:
      name: hcloud-csi-node
  template:
    metadata:
      annotations: {}
      labels:
        name: hcloud-csi-node
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: instance.hetzner.cloud/is-root-server
                    operator: NotIn
                    values:
                      - 'true'
      containers:
        - args: []
          command:
            - /bin/hcloud-csi-driver-node
          env:
            - name: CSI_ENDPOINT
              value: unix:///run/csi/socket
            - name: ENABLE_METRICS
              value: 'true'
            - name: HCLOUD_TOKEN
              valueFrom:
                secretKeyRef:
                  key: token
                  name: hcloud-token
            - name: KUBE_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: METRICS_ENDPOINT
              value: 0.0.0.0:9189
          image: docker.io/hetznercloud/hcloud-csi-driver:2.1.1
          imagePullPolicy: IfNotPresent
          livenessProbe:
            failureThreshold: 5
            httpGet:
              path: /healthz
              port: healthz
            initialDelaySeconds: 10
            periodSeconds: 2
            timeoutSeconds: 3
          name: hcloud-csi-driver
          ports:
            - containerPort: 9808
              name: healthz
            - containerPort: 9189
              name: metrics
          resources: {}
          securityContext:
            privileged: true
          stdin: false
          tty: false
          volumeMounts:
            - mountPath: /dev
              name: device-dir
            - mountPath: /var/lib/kubelet
              mountPropagation: Bidirectional
              name: kubelet-dir
            - mountPath: /run/csi
              name: plugin-dir
        - args: []
          env: []
          image: registry.k8s.io/sig-storage/livenessprobe:v2.9.0
          imagePullPolicy: IfNotPresent
          name: liveness-probe
          ports: []
          resources: {}
          stdin: false
          tty: false
          volumeMounts:
            - mountPath: /run/csi
              name: plugin-dir
        - args:
            - --kubelet-registration-path=/var/lib/kubelet/plugins/csi.hetzner.cloud/socket
          env: []
          image: registry.k8s.io/sig-storage/csi-node-driver-registrar:v2.7.0
          imagePullPolicy: IfNotPresent
          name: csi-registrar
          ports: []
          resources: {}
          stdin: false
          tty: false
          volumeMounts:
            - mountPath: /run/csi
              name: plugin-dir
            - mountPath: /registration
              name: registration-dir
      imagePullSecrets: []
      initContainers: []
      terminationGracePeriodSeconds: 30
      tolerations:
        - effect: NoExecute
          operator: Exists
        - effect: NoSchedule
          operator: Exists
        - key: CriticalAddonsOnly
          operator: Exists
      volumes:
        - hostPath:
            path: /dev
            type: Directory
          name: device-dir
        - hostPath:
            path: /var/lib/kubelet
            type: Directory
          name: kubelet-dir
        - hostPath:
            path: /var/lib/kubelet/plugins/csi.hetzner.cloud/
            type: DirectoryOrCreate
          name: plugin-dir
        - hostPath:
            path: /var/lib/kubelet/plugins_registry/
            type: Directory
          name: registration-dir
  updateStrategy:
    rollingUpdate:
      maxUnavailable: 1
    type: RollingUpdate
---
apiVersion: v1
kind: Service
metadata:
  annotations: {}
  labels:
    name: hcloud-csi-node
  name: hcloud-csi-node
spec:
  ports:
    - name: healthz
      port: 9808
      targetPort: 9808
  selector:
    name: hcloud-csi-node
  sessionAffinity: None
  type: ClusterIP
